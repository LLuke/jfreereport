<!-- An ANT build file for JFreeReport -->

<!-- This file builds all parser and writer modules. -->

<project name="jfreereport" default="all" basedir="..">

  <target name="init">
    <dirname property="antfile.dir" file="${ant.file}"/>
    <ant antfile="${antfile.dir}/build-core.xml" target="init"/>
    <property file="${antfile.dir}/build.properties"/>

    <available file="${core-jar-file}" type="file" property="core-jar-file-present"/>
    <antcall target="rebuild-core"/>
  </target>

  <target name="rebuild-core" unless="core-jar-file-present">
    <echo>
      Rebuilding core ...
    </echo>
    <dirname property="antfile.dir" file="${ant.file}"/>
    <ant antfile="${antfile.dir}/build-core.xml" target="all"/>
  </target>

  <!-- ************************************************************** -->
  <!--                                                                -->
  <!--  parser base modules                                           -->
  <!--                                                                -->
  <!--  Depends on: Core task                                         -->
  <!-- ************************************************************** -->

  <target name="init-module-parser-base" depends="init" >
    <available file="${libdir}/${jcommon-xml-jar-file}" property="jcommon-xml-jar-file-present" />
    <fail unless="jcommon-xml-jar-file-present">
      The file ${jcommon-xml-jar-file} was not found in the lib directory.
    </fail>

    <available classname="org.xml.sax.InputSource" property="jaxp-api-present">
      <classpath>
        <pathelement location="${libdir}/${jaxp-jar-file}" />
      </classpath>
    </available>
    <fail unless="jaxp-api-present">
      The file ${jaxp-jar-file} was not found in the lib directory or
      this build is not executed on a system that would provide an own JAXP
      implementation (like JDK 1.4 or higher).

      No XML API available; aborting.
    </fail>
  </target>

  <target name="compile-module-parser-base"
    depends="init-module-parser-base">
    <description>
      Compiles the parser-base module classes of JFreeReport.
      This contains common classes for all parsers and the parser frontend implementation.
    </description>

    <!-- create a temp build directory -->
    <mkdir dir="build"/>

    <!-- compile the source -->
    <!-- We exclude all module implementations by default -->
    <javac srcdir="source"
      destdir="build" target="${build.target}"
      deprecation="${build.deprecation}" debug="${build.debug}" optimize="${build.optimize}">
      <include name="org/jfree/report/modules/parser/base/**"/>
      <classpath>
        <pathelement location="${libdir}/${jcommon-jar-file}" />
        <pathelement location="${libdir}/${jcommon-xml-jar-file}" />
        <pathelement location="${libdir}/${jaxp-jar-file}" />
        <pathelement location="${core-jar-file}"/>
      </classpath>
    </javac>

    <antcall target="copy-resources-parser-base" inheritAll="true"/>

    <!-- make the jar -->
    <jar jarfile="${module-parser-base-file}"
         basedir="build">
      <manifest>
          <attribute name="Class-Path" value="${core-jar-file} ${manifest-lib-prefix}${jaxp-jar-file}"/>
      </manifest>
    </jar>

    <!-- delete the temp directory -->
    <delete dir="build" />
  </target>

  <target name="copy-resources-parser-base">
    <copy file="source/org/jfree/report/modules/parser/base/module.properties"
      tofile="build/org/jfree/report/modules/parser/base/module.properties"/>
  </target>

  <!-- ************************************************************** -->
  <!--                                                                -->
  <!--  Extended parser  modules                                      -->
  <!--                                                                -->
  <!--  Depends on: parser base                                       -->
  <!-- ************************************************************** -->

  <target name="compile-module-parser-ext" depends="compile-module-parser-base">
    <description>
      Compiles the extended parser. This parser is also required if the
      report writer is built.
    </description>

    <!-- create a temp build directory -->
    <mkdir dir="build"/>

    <!-- compile the source -->
    <!-- We exclude all module implementations by default -->
    <javac srcdir="source"
      destdir="build" target="${build.target}"
      deprecation="${build.deprecation}" debug="${build.debug}" optimize="${build.optimize}">
      <include name="org/jfree/report/modules/parser/ext/**"/>
      <classpath>
        <pathelement location="${libdir}/${jcommon-jar-file}" />
        <pathelement location="${libdir}/${jcommon-xml-jar-file}" />
        <pathelement location="${libdir}/${jaxp-jar-file}" />
        <pathelement location="${core-jar-file}"/>
        <pathelement location="${module-parser-base-file}"/>
      </classpath>
    </javac>

    <antcall target="copy-resources-parser-ext"/>

    <!-- make the jar -->
    <jar jarfile="${module-parser-ext-file}"
         basedir="build">
      <manifest>
          <attribute name="Class-Path" value="${core-jar-file} ${module-parser-base-file}"/>
      </manifest>
    </jar>

    <!-- delete the temp directory -->
    <delete dir="build" />
  </target>

  <target name="copy-resources-parser-ext">
    <copy file="source/org/jfree/report/modules/parser/ext/module.properties"
      tofile="build/org/jfree/report/modules/parser/ext/module.properties"/>

    <copy file="source/org/jfree/report/modules/parser/ext/resources/extreport-085.dtd"
      tofile="build/org/jfree/report/modules/parser/ext/resources/extreport-085.dtd"/>
  </target>

  <!-- ************************************************************** -->
  <!--                                                                -->
  <!--  Extended parser writer modules                                -->
  <!--                                                                -->
  <!--  Depends on: parser base, ext parser                           -->
  <!-- ************************************************************** -->

  <target name="compile-module-parser-extwriter" depends="compile-module-parser-ext">
    <description>
      Compiles the report writer.
    </description>

    <!-- create a temp build directory -->
    <mkdir dir="build"/>

    <!-- compile the source -->
    <!-- We exclude all module implementations by default -->
    <javac srcdir="source"
      destdir="build" target="${build.target}"
      deprecation="${build.deprecation}" debug="${build.debug}" optimize="${build.optimize}">
      <include name="org/jfree/report/modules/parser/extwriter/**"/>
      <classpath>
        <pathelement location="${libdir}/${jcommon-jar-file}" />
        <pathelement location="${libdir}/${jcommon-xml-jar-file}" />
        <pathelement location="${libdir}/${jaxp-jar-file}" />
        <pathelement location="${core-jar-file}"/>
        <pathelement location="${module-parser-base-file}"/>
        <pathelement location="${module-parser-ext-file}"/>
      </classpath>
    </javac>

    <antcall target="copy-resources-parser-extwriter" inheritAll="true"/>
    <!-- make the jar -->
    <jar jarfile="${module-parser-extwriter-file}"
         basedir="build">
      <manifest>
          <attribute name="Main-Class" value="org.jfree.report.modules.parser.extwriter.ReportConverter"/>
          <attribute name="Class-Path" value="${core-jar-file} ${module-parser-base-file} ${module-parser-ext-file}"/>
      </manifest>
    </jar>

    <!-- delete the temp directory -->
    <delete dir="build" />
  </target>

  <target name="copy-resources-parser-extwriter">
    <copy file="source/org/jfree/report/modules/parser/extwriter/module.properties"
      tofile="build/org/jfree/report/modules/parser/extwriter/module.properties"/>
  </target>

  <!-- ************************************************************** -->
  <!--                                                                -->
  <!--  Simple parser modules                                         -->
  <!--                                                                -->
  <!--  Depends on: parser base, ext parser                           -->
  <!-- ************************************************************** -->

  <target name="compile-module-parser-simple" depends="compile-module-parser-base">
    <description>
      Compiles the simple report parser.
    </description>

    <!-- create a temp build directory -->
    <mkdir dir="build"/>

    <!-- compile the source -->
    <!-- We exclude all module implementations by default -->
    <javac srcdir="source"
      destdir="build" target="${build.target}"
      deprecation="${build.deprecation}" debug="${build.debug}" optimize="${build.optimize}">
      <include name="org/jfree/report/modules/parser/simple/**"/>
      <classpath>
        <pathelement location="${libdir}/${jcommon-jar-file}" />
        <pathelement location="${libdir}/${jcommon-xml-jar-file}" />
        <pathelement location="${libdir}/${jaxp-jar-file}" />
        <pathelement location="${core-jar-file}"/>
        <pathelement location="${module-parser-base-file}"/>
      </classpath>
    </javac>

    <antcall target="copy-resources-parser-simple" inheritAll="true"/>

    <!-- make the jar -->
    <jar jarfile="${module-parser-simple-file}"
         basedir="build">
      <manifest>
          <attribute name="Class-Path" value="${core-jar-file} ${module-parser-base-file}"/>
      </manifest>
    </jar>

    <!-- delete the temp directory -->
    <delete dir="build" />
  </target>

  <target name="copy-resources-parser-simple">
    <copy file="source/org/jfree/report/modules/parser/simple/module.properties"
      tofile="build/org/jfree/report/modules/parser/simple/module.properties"/>

    <copy file="source/org/jfree/report/modules/parser/simple/resources/report-085.dtd"
      tofile="build/org/jfree/report/modules/parser/simple/resources/report-085.dtd"/>
  </target>

  <!--
    This target is called from build-all
    -->
  <target name="copy-resources"
    depends="copy-resources-parser-base,
    copy-resources-parser-ext,
    copy-resources-parser-extwriter,
    copy-resources-parser-simple" />

  <target name="compile"
    depends="compile-module-parser-base,
    compile-module-parser-ext,
    compile-module-parser-extwriter,
    compile-module-parser-simple"/>

  <target name="all" depends="init, compile"/>

</project>